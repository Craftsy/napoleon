!function(t,e){if("function"==typeof define&&define.amd)define(["exports"],e);else if("undefined"!=typeof exports)e(exports);else{var r={exports:{}};e(r.exports),t.napoleon=r.exports}}(this,function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function t(r){var n=this;e(this,t),r=t.getPathname(r);var o=r.match(/(.*?)($|\?(.*))/),a=o[1],i=o[3];this.segments=a.split("/").filter(function(t){return t.length>0}),this.querystring={},null!=i&&i.split("&").forEach(function(t){var e=t.split("="),r=e[0],o=e[1];n.querystring[r]=decodeURIComponent(o)})}return t.isSegmentKey=function(t){return"{"===t.charAt(0)&&"}"===t.charAt(t.length-1)},t.getSegmentKey=function(e){var r=null;return t.isSegmentKey(e)&&(r=e.slice(1,-1)),r},t.getPathname=function(t){var e=t.match(/.*?\/\/.*?\//),r=e?e[0]:"/";return t.replace(r,"/")},t.prototype.getUrlForState=function(e){for(var r=[],n=this.segments.reduce(function(n,o){var a=t.getSegmentKey(o);if(r.push(a),null!=a){var i=e[a];null!=i&&(n+="/"+i)}else n+="/"+o;return n},""),o=[],a=Object.keys(e),i=0;i<a.length;i++){var s=a[i];if(-1===r.indexOf(s)){var l=e[s];o.push(s+"="+encodeURIComponent(l))}}return o.length>0&&(n+="?"+o.join("&")),n},t.prototype.extractParameters=function(e){var r=new t(e),n={};this.segments.forEach(function(e,o){var a=t.getSegmentKey(e);null!=a?n[a]=r.segments[o]:"*"===e&&(n.blat=r.segments.slice(o).join("/"))});var o=Object.keys(r.querystring);return o.forEach(function(t){if(!n.hasOwnProperty(t)){var e=r.querystring[t];n[t]=e}}),n},t.prototype.toString=function(){var t="/"+this.segments.join("/"),e=[],r="",n=!0,o=!1,a=void 0;try{for(var i,s=Object.keys(this.querystring)[Symbol.iterator]();!(n=(i=s.next()).done);n=!0){var l=i.value;e.push("key="+encodeURIComponent(this.querystring[l]))}}catch(u){o=!0,a=u}finally{try{!n&&s["return"]&&s["return"]()}finally{if(o)throw a}}return e.length>0&&(r="?"+e.join("&")),""+t+r},t}();t.URLStructure=r;var n="?dynamic?",o="?blat?",a=function(){function t(){e(this,t),this.leaf=null,this.children={}}return t.prototype.addRoute=function(e,a){var i=arguments.length<=2||void 0===arguments[2]?0:arguments[2],s=a.segments[i];if(null==s){if(null!=this.leaf)throw new Error("Route "+a+" already mounted: "+this.leaf.urlStructure);this.leaf={urlStructure:a,handler:e}}else{var l=void 0;if("*"===s){if(i<a.segments.length-1)throw new Error("Route "+a+" cannot have path segments after the blat (*)");l=o}else{var u=r.getSegmentKey(s);l=null==u?s:n}this.children.hasOwnProperty(l)||(this.children[l]=new t),this.children[l].addRoute(e,a,i+1)}},t.prototype.matchPath=function(t){var e=arguments.length<=1||void 0===arguments[1]?0:arguments[1];console.log("matchPath("+t+", "+e+")");var r=null;if(e===t.segments.length)console.log("at the end! leaf is",this.leaf),r=this.leaf,null==r&&0===e&&null==r&&this.children.hasOwnProperty(o)&&(r=this.children[o].leaf);else{var a=t.segments[e];this.children.hasOwnProperty(a)&&(r=this.children[a].matchPath(t,e+1)),null==r&&this.children.hasOwnProperty(n)&&(r=this.children[n].matchPath(t,e+1)),null==r&&this.children.hasOwnProperty(o)&&(r=this.children[o].leaf)}return r},t}();t.TreeRoute=a;var i=function(){function t(){e(this,t),this.namedRoutes={},this.trees={}}return t.prototype.mount=function(t){var e=t.method,n=void 0===e?"get":e,o=t.url,i=t.handler,s=t.name;n=n.toLowerCase();var l=new r(o);if(null==this.trees[n]&&(this.trees[n]=new a),this.trees[n].addRoute(i,l),null!=s){if(this.namedRoutes.hasOwnProperty(s))throw new Error("Conflict for route name "+s+": "+o+" / "+this.namedRoutes[s].url);this.namedRoutes[s]=t}return this},t.prototype.matchRoute=function(t,e){t=t.toLowerCase();var n=new r(e),o=null;return this.trees.hasOwnProperty(t)&&(o=this.trees[t].matchPath(n)),o},t.prototype.route=function(t,e,r){t=t.toLowerCase();var n=this.matchRoute(t,e),o=null;return null!=n&&(o=n.urlStructure.extractParameters(e),n.handler(o,r)),o},t.prototype.getNamedRoute=function(t){return this.namedRoutes[t]||null},t}();t.Router=i;var s=function(){var t=null,e=null,n={isNapoleon:!0,url:{},extras:{}},o=function(){n=null==window.history.state||window.history.state.isNapoleon!==!0?{isNapoleon:!0,url:t.extractParameters(location.href),extras:{}}:window.history.state;var r=n,o=r.url,a=r.extras;e({url:o,extras:a})};return{attach:function(n){var a=n.url,i=n.onStateChange;if(null==a)throw new Error("Missing `url` in Napoleon config");if(null==i)throw new Error("Missing `onStateChange` in Napoleon config");t=new r(a),e=i,window.addEventListener("popstate",o),o()},modifyState:function(e){var r=e.url,a=e.extras,i=e.replace;if(null!=r)for(var s in r)if(r.hasOwnProperty(s)){var l=r[s];null==l?delete n.url[s]:n.url[s]=l}if(null!=a)for(var s in a)if(a.hasOwnProperty(s)){var l=a[s];null==l?delete n.extras[s]:n.extras[s]=l}i===!0?window.history.replaceState(n,"",t.getUrlForState(n.url)):window.history.pushState(n,"",t.getUrlForState(n.url)),o()}}}(void 0);t["default"]=s});